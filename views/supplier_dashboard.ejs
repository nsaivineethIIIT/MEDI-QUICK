<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MediQuick | Supplier Dashboard</title>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap");

      :root {
        --blue: #0188df;
        --black: #444d53;
        --white: #fff;
      }

      * {
        font-family: "Roboto", sans-serif;
        margin: 0;
        padding: 0;
        text-decoration: none;
        /* text-transform: capitalize; */
        outline: none;
        box-sizing: border-box;
        transition: all linear 0.2s;
      }

      html {
        font-size: 62.5%;
        overflow-x: hidden;
        scroll-behavior: smooth;
      }

      .button {
        height: 3.5rem;
        width: 15rem;
        background: var(--black);
        color: var(--white);
        font-size: 1.7rem;
        text-transform: capitalize;
        border-radius: 0.5rem;
        cursor: pointer;
        margin: 1rem 0;
        border: 0.1rem solid var(--blue);
      }

      .button:hover {
        border: 0.1rem solid var(--blue);
        background: var(--white);
        color: var(--blue);
        letter-spacing: 0.2rem;
      }

      .heading {
        text-align: center;
        font-size: 4rem;
        padding: 1rem;
        padding-top: 8rem;
        color: var(--blue);
        letter-spacing: 0.1rem;
      }

      .title {
        text-align: center;
        padding: 0rem 1rem;
        font-size: 2.5rem;
        color: var(--black);
        font-weight: 300;
      }

      header {
        width: 96%;
        background: var(--white);
        position: fixed;
        top: 2rem;
        left: 50%;
        transform: translate(-50%);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 2rem;
        z-index: 1000;
      }

      header a {
        color: var(--black);
      }

      header a:hover {
        color: var(--blue);
      }

      header .logo {
        font-size: 3rem;
      }

      header .logo span {
        color: var(--blue);
      }

      header .navbar ul {
        display: flex;
        align-items: center;
        justify-content: space-between;
        list-style: none;
      }

      header .navbar ul li {
        margin: 0 1rem;
      }

      header .navbar ul li a {
        font-size: 2rem;
        color: var(--black);
      }

      header .navbar ul li a:hover {
        color: var(--blue);
      }

      header .fa-bars {
        font-size: 3rem;
        color: var(--blue);
        cursor: pointer;
        display: none;
      }

      header .fa-times {
        transform: rotate(180deg);
      }

      .header-active {
        top: 0;
        width: 100%;
        box-shadow: 0.1rem 0.3rem rgba(0, 0, 0, 0.3);
      }

      .footer {
        background: var(--black);
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        padding: 2rem 0;
      }

      .footer .box {
        width: 30rem;
        margin: 2rem;
        text-align: center;
      }

      .footer .box .logo {
        padding: 2rem 0;
        font-size: 3rem;
        color: var(--white);
      }

      .footer .box .logo:hover {
        color: var(--blue);
      }

      .footer .box .logo span {
        color: var(--blue);
      }

      .footer .box p {
        font-size: 1.5rem;
        color: var(--white);
      }

      .footer .box a {
        color: var(--white);
        font-size: 2rem;
        display: block;
        padding: 0.2rem 0;
      }

      .footer .box a:hover {
        text-decoration: underline;
      }

      .footer .credit {
        width: 85%;
        padding-top: 1rem;
        font-size: 2rem;
        color: var(--white);
        text-align: center;
        border-top: 0.2rem solid var(--white);
      }

      .footer .credit span {
        color: var(--blue);
        text-decoration: underline;
        letter-spacing: 0.5rem;
      }

      .dashboard {
        margin-top: 80px;
        font-size: 1.5rem;
      }

      .nav-links {
        display: flex;
        justify-content: center;
        background-color: var(--black);
        padding: 10px;
        font-size: 1.5rem;
      }

      .nav-links a {
        color: var(--white);
        text-decoration: none;
        padding: 10px 20px;
        margin: 0 10px;
        background-color: var(--blue);
        border-radius: 5px;
      }

      .nav-links a:hover {
        background-color: #0168a7;
      }

      .main-content {
        flex: 1;
        padding: 20px;
        background-color: var(--white);
      }

      .medicine-list {
        margin-bottom: 20px;
      }

      .medicine-list table {
        width: 100%;
        border-collapse: collapse;
      }

      .medicine-list th,
      .medicine-list td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }

      .medicine-list th {
        background-color: var(--blue);
        color: var(--white);
      }

      .add-medicine-form {
        margin-top: 20px;
      }

      .add-medicine-form input {
        margin: 5px 0;
        padding: 8px;
        width: calc(100% - 16px);
      }

      .add-medicine-form button {
        padding: 10px 20px;
        background-color: var(--blue);
        color: var(--white);
        border: none;
        cursor: pointer;
      }

      .add-medicine-form button:hover {
        background-color: #0168a7;
      }

      .remove-btn {
        background-color: #ff4d4d;
        color: var(--white);
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 3px;
      }

      .remove-btn:hover {
        background-color: #cc0000;
      }

      @media (max-width: 768px) {
        html {
          font-size: 55%;
        }

        header .fa-bars {
          display: block;
        }

        header .navbar {
          position: fixed;
          top: -100rem;
          left: 0;
          width: 100%;
          background: var(--white);
          opacity: 0;
        }

        header .navbar ul {
          flex-flow: column;
          padding: 2rem 0;
        }

        header .navbar ul li {
          margin: 1rem 0;
          width: 100%;
          text-align: center;
        }

        header .navbar ul li a {
          font-size: 2rem;
          display: block;
        }

        header .nav-toggle {
          top: 5.5rem;
          opacity: 1;
        }
      }
    </style>
  </head>

  <body>
    <header>
      <a href="/" class="logo"
        ><span style="color: var(--blue)">M</span>edi<span
          style="color: var(--blue)"
          >Q</span
        >uick</a
      >
      <nav class="navbar">
        <ul>
          <li><a href="/">Home</a></li>
          <li><a href="/about">About Us</a></li>
          <li><a href="/faqs">FAQs</a></li>
          <li><a href="/blogs">Blog</a></li>
          <li><a href="/contact">Contact Us</a></li>
          <li><a href="/logout">LogOut</a></li>
          <li>
            <a href="/supplier/profile"
              ><img
                src="https://static.thenounproject.com/png/638636-200.png"
                alt="Profile Image"
                height="30px"
                width="30px"
            /></a>
          </li>
        </ul>
      </nav>
      <div class="fas fa-bars"></div>
    </header>
    <div class="dashboard">
      <div class="nav-links">
        <a href="#medicine-list">Medicine List</a>
        <a href="#add-medicine">Add New Medicine</a>
      </div>
      <div class="main-content">
        <div id="medicine-list" class="medicine-list">
          <h2>Available Medicines</h2>
          <table>
            <thead>
              <tr>
                <th>Medicine Name</th>
                <th>Medicine ID</th>
                <th>Quantity</th>
                <th>Cost ($)</th>
                <th>Manufacturer</th>
                <th>Expiry Date</th>
                <th>Total Income ($)</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="medicineTableBody">
              <!-- Medicines will be populated dynamically -->
            </tbody>
          </table>
        </div>
        <div id="add-medicine" class="add-medicine-form">
          <h2>Add New Medicine</h2>
          <form id="addMedicineForm">
            <input
              type="text"
              id="medicineName"
              placeholder="Medicine Name"
              required
            />
            <input
              type="text"
              id="medicineID"
              placeholder="Medicine ID"
              required
            />
            <input
              type="number"
              id="quantity"
              placeholder="Quantity"
              required
              min="0"
            />
            <input
              type="number"
              id="cost"
              placeholder="Cost per unit ($)"
              required
              min="0"
              step="0.01"
            />
            <input
              type="text"
              id="manufacturer"
              placeholder="Manufacturer"
              required
            />
            <input
              type="date"
              id="expiryDate"
              placeholder="Expiry Date"
              required
            />
            <button type="submit">Add Medicine</button>
          </form>
        </div>
        <div class="orders-list">
          <h2>Recent Orders</h2>
          <table>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Medicine</th>
                <th>Patient</th>
                <th>Quantity</th>
                <th>Total Cost</th>
                <th>Status</th>
                <th>Order Date</th>
              </tr>
            </thead>
            <tbody id="ordersTableBody">
              <!-- Orders will be populated dynamically -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <%- include('partials/footer') %>

    <!-- jQuery CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <script>
      // Simple custom message box function to replace alert()
      function showCustomMessage(message, type = "success") {
        const messageBox = document.createElement("div");
        messageBox.textContent = message;
        messageBox.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            font-family: Arial, sans-serif;
            text-align: center;
            color: white;
            background-color: ${type === "success" ? "#4CAF50" : "#f44336"};
        `;
        document.body.appendChild(messageBox);
        setTimeout(() => {
          document.body.removeChild(messageBox);
        }, 3000);
      }

      $(document).ready(function () {
        // Initialize navigation toggle
        $(".fa-bars").click(function () {
          $(this).toggleClass("fa-times");
          $(".navbar").toggleClass("nav-toggle");
        });

        $(window).on("scroll load", function () {
          $(".fa-bars").removeClass("fa-times");
          $(".navbar").removeClass("nav-toggle");
          if ($(window).scrollTop() > 30) {
            $("header").addClass("header-active");
          } else {
            $("header").removeClass("header-active");
          }
        });

        // Fetch medicines and orders on page load
        fetchMedicines();
        fetchOrders();

        // Handle form submission for adding medicine
        $("#addMedicineForm").on("submit", function (event) {
          event.preventDefault();
          const medicineData = {
            name: $("#medicineName").val().trim(),
            medicineID: $("#medicineID").val().trim(),
            quantity: parseInt($("#quantity").val()),
            cost: parseFloat($("#cost").val()),
            manufacturer: $("#manufacturer").val().trim(),
            expiryDate: $("#expiryDate").val(),
          };

          $.ajax({
            url: "/supplier/api/add-medicine", // Corrected endpoint
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify(medicineData),
            success: function (response) {
              showCustomMessage(response.message);
              $("#addMedicineForm").trigger("reset");
              fetchMedicines();
            },
            error: function (xhr) {
              const error = xhr.responseJSON?.error || "Failed to add medicine";
              const details = xhr.responseJSON?.details || "";
              showCustomMessage(`${error}: ${details}`, "error");
            },
          });
        });

        // Function to fetch and display medicines with total income
        function fetchMedicines() {
          $.ajax({
            url: "/supplier/api/medicines", // Corrected endpoint
            method: "GET",
            success: function (medicines) {
              // Fetch orders to calculate total income for each medicine
              $.ajax({
                url: "/supplier/api/orders", // Corrected endpoint
                method: "GET",
                success: function (orders) {
                  if (!Array.isArray(orders)) {
                    console.error("Orders is not an array:", orders);
                    orders = [];
                  }

                  // Calculate total income per medicine
                  const incomeByMedicine = {};
                  orders.forEach((order) => {
                    if (order.medicineId && order.medicineId.id) {
                      const medicineId = order.medicineId.id;
                      if (!incomeByMedicine[medicineId]) {
                        incomeByMedicine[medicineId] = 0;
                      }
                      incomeByMedicine[medicineId] += order.totalCost || 0;
                    }
                  });

                  const tableBody = $("#medicineTableBody");
                  tableBody.empty();
                  if (medicines.length === 0) {
                    tableBody.append(
                      '<tr><td colspan="8">No medicines found</td></tr>'
                    );
                  } else {
                    medicines.forEach((medicine) => {
                      const totalIncome = incomeByMedicine[medicine.id] || 0;
                      const row = `
                                        <tr data-id="${medicine.id}">
                                            <td>${medicine.name}</td>
                                            <td>${medicine.medicineID}</td>
                                            <td>${medicine.quantity}</td>
                                            <td>$${medicine.cost}</td>
                                            <td>${medicine.manufacturer}</td>
                                            <td>${medicine.expiryDate}</td>
                                            <td>$${totalIncome.toFixed(2)}</td>
                                            <td><button class="remove-btn" onclick="removeMedicine('${
                                              medicine.id
                                            }')">Remove</button></td>
                                        </tr>
                                    `;
                      tableBody.append(row);
                    });
                  }
                },
                error: function (xhr) {
                  console.error("Error fetching orders:", xhr.responseText);
                  showCustomMessage("Failed to load orders.", "error");
                  const tableBody = $("#medicineTableBody");
                  tableBody.empty();
                  if (medicines.length === 0) {
                    tableBody.append(
                      '<tr><td colspan="8">No medicines found</td></tr>'
                    );
                  } else {
                    medicines.forEach((medicine) => {
                      const row = `
                                        <tr data-id="${medicine.id}">
                                            <td>${medicine.name}</td>
                                            <td>${medicine.medicineID}</td>
                                            <td>${medicine.quantity}</td>
                                            <td>$${medicine.cost}</td>
                                            <td>${medicine.manufacturer}</td>
                                            <td>${medicine.expiryDate}</td>
                                            <td>$0.00</td>
                                            <td><button class="remove-btn" onclick="removeMedicine('${medicine.id}')">Remove</button></td>
                                        </tr>
                                    `;
                      tableBody.append(row);
                    });
                  }
                },
              });
            },
            error: function (xhr) {
              const error =
                xhr.responseJSON?.error || "Failed to fetch medicines";
              showCustomMessage(error, "error");
              $("#medicineTableBody").html(
                '<tr><td colspan="8">Error loading medicines</td></tr>'
              );
            },
          });
        }

        // Function to remove medicine
        window.removeMedicine = function (medicineId) {
          if (confirm("Are you sure you want to remove this medicine?")) {
            $.ajax({
              url: `/supplier/api/medicines/${medicineId}`, // Corrected endpoint
              method: "DELETE",
              success: function (response) {
                showCustomMessage(response.message);
                fetchMedicines();
              },
              error: function (xhr) {
                const error =
                  xhr.responseJSON?.error || "Failed to remove medicine";
                showCustomMessage(error, "error");
              },
            });
          }
        };

        // Enhanced fetchOrders function
        function fetchOrders() {
          $.ajax({
            url: "/supplier/api/orders", // Corrected endpoint
            method: "GET",
            success: function (orders) {
              const tableBody = $("#ordersTableBody");
              tableBody.empty();

              if (orders.length === 0) {
                tableBody.append(
                  '<tr><td colspan="7">No orders found</td></tr>'
                );
                return;
              }

              orders.forEach((order) => {
                const row = `
                        <tr>
                            <td>${order.id.toString().substring(0, 8)}</td>
                            <td>${order.medicine || "Unknown"} (${
                  order.medicineId || "N/A"
                })</td>
                            <td>${order.patient || "Unknown"}</td>
                            <td>${order.quantity}</td>
                            <td>$${order.totalCost?.toFixed(2) || "0.00"}</td>
                            <td class="status-${order.status}">${
                  order.status
                }</td>
                            <td>${order.orderDate || "N/A"}</td>
                        </tr>
                    `;
                tableBody.append(row);
              });
            },
            error: function (xhr) {
              console.error("Error fetching orders:", xhr.responseText);
              $("#ordersTableBody").html(
                '<tr><td colspan="7">Error loading orders</td></tr>'
              );
            },
          });
        }

        setInterval(fetchOrders, 10000); // Refresh every 10 seconds
      });
    </script>
  </body>
</html>
